<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GlycoGuide - Diabetes Care Assistant</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ------------------
       Design Tokens
    -------------------*/
    :root {
      --bg: hsl(200, 30%, 98%);
      --bg-elev: hsl(0, 0%, 100%);
      --text: hsl(215, 20%, 15%);
      --muted: hsl(210, 25%, 96%);
      --muted-2: hsl(210, 20%, 92%);
      --border: hsl(210, 20%, 86%);
      --primary: hsl(190, 85%, 35%);           /* medical teal */
      --primary-2: hsl(190, 85%, 45%);
      --primary-3: hsl(190, 85%, 60%);
      --danger: hsl(0, 75%, 50%);
      --ok: hsl(150, 55%, 40%);
      --shadow-1: 0 6px 24px hsl(190 85% 25% / 0.08);
      --shadow-2: 0 10px 30px hsl(200 40% 20% / 0.12);
      --radius-lg: 18px;
      --radius-md: 14px;
      --radius-sm: 12px;
      --grad:
        radial-gradient(1000px 600px at 90% -50%, hsl(190 85% 50% / .12) 0, transparent 55%),
        radial-gradient(1000px 600px at -10% 110%, hsl(210 90% 60% / .12) 0, transparent 50%),
        linear-gradient(180deg, hsl(0 0% 100% / .85), hsl(0 0% 100% / .85));
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 800px at -20% -30%, hsl(190 85% 80% / .25), transparent 40%),
        radial-gradient(1200px 800px at 120% 130%, hsl(210 85% 80% / .25), transparent 40%),
        var(--bg);
      overflow: hidden;
    }

    /* Layout */
    .app {
      max-width: 1400px;
      height: 100vh;
      margin: 0 auto;
      padding: 18px;
      display: grid;
      grid-template-columns: 1fr 340px;
      gap: 18px;
    }

    .panel {
      background: var(--grad);
      border: 1px solid var(--border);
      border-radius: calc(var(--radius-lg) + 6px);
      box-shadow: var(--shadow-2);
      overflow: hidden;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px 18px;
      background:
        linear-gradient(135deg, hsl(190 85% 40% / .14), hsl(210 85% 55% / .14));
      border-bottom: 1px solid var(--border);
      position: relative;
    }
    .brand {
      display: flex; align-items: center; gap: 12px;
    }
    .logo {
      width: 40px; height: 40px; border-radius: 12px;
      display: grid; place-items: center;
      background: linear-gradient(135deg, var(--primary-2), var(--primary-3));
      color: white; font-weight: 700; box-shadow: var(--shadow-1);
    }
    .title { font-weight: 700; letter-spacing: 0.2px; }
    .subtitle { font-size: 12px; opacity: .75; }

    .header-actions { margin-left: auto; display: flex; gap: 10px; }
    .pill {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 8px 12px; border-radius: 999px;
      background: hsl(190 85% 40% / .12);
      color: hsl(190 85% 20%);
      border: 1px solid var(--border);
      font-size: 12px; font-weight: 600;
    }
    .upload-button {
      padding: 8px 12px;
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      border: none; color: white; border-radius: 10px; cursor: pointer;
      font-weight: 600; box-shadow: var(--shadow-1);
      transition: transform .15s ease, filter .15s ease;
    }
    .upload-button:hover { transform: translateY(-1px); filter: brightness(1.05); }
    #fileInput { display: none; }

    /* Chat area */
    .chat {
      display: grid; grid-template-rows: auto 1fr auto;
      height: 100%;
    }

    .messages {
      padding: 16px;
      overflow-y: auto; scroll-behavior: smooth;
      display: flex; flex-direction: column; gap: 14px;
      background:
        radial-gradient(800px 400px at 50% -5%, hsl(190 85% 60% / .08), transparent 60%),
        var(--bg-elev);
    }
    /* Nice scroll */
    .messages::-webkit-scrollbar { width: 10px; }
    .messages::-webkit-scrollbar-thumb {
      background: var(--muted-2); border-radius: 999px; border: 2px solid transparent; background-clip: padding-box;
    }

    .msg { display: flex; gap: 12px; max-width: 780px; }
    .msg.user { margin-left: auto; flex-direction: row-reverse; }

    .avatar {
      width: 40px; height: 40px; border-radius: 12px; flex-shrink: 0;
      display: grid; place-items: center; font-size: 20px; color: white;
      background: linear-gradient(135deg, var(--primary-2), var(--primary-3));
      box-shadow: var(--shadow-1);
    }
    .avatar.user { background: linear-gradient(135deg, hsl(215 20% 20%), hsl(215 20% 35%)); }

    .bubble {
      position: relative;
      background: var(--bg-elev);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px 14px;
      line-height: 1.5;
      box-shadow: var(--shadow-1);
    }

    .msg.user .bubble {
      background: linear-gradient(135deg, var(--primary-2), var(--primary-3));
      color: white; border-color: transparent;
    }

    .bubble strong { font-weight: 700; }
    .bubble em { font-style: italic; }

    /* Typing indicator */
    .typing {
      display: inline-flex; gap: 6px; align-items: center;
    }
    .dot {
      width: 8px; height: 8px; border-radius: 50%; background: var(--primary);
      animation: pulse 1.4s infinite ease-in-out;
    }
    .dot:nth-child(2) { animation-delay: .15s; }
    .dot:nth-child(3) { animation-delay: .3s; }
    @keyframes pulse { 0%, 80%, 100% { transform: scale(.75); opacity: .5 } 40% { transform: scale(1); opacity: 1 } }

    /* Input */
    .composer {
      padding: 12px; border-top: 1px solid var(--border); background: var(--bg-elev);
    }
    .composer-wrap {
      display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;
    }
    .input {
      width: 100%;
      padding: 14px 16px; border-radius: 999px; outline: none;
      border: 1px solid var(--border); background: var(--muted);
      font-size: 14px; box-shadow: var(--shadow-1);
      transition: box-shadow .2s ease, border-color .2s ease;
    }
    .input:focus { border-color: var(--primary-2); box-shadow: 0 0 0 4px hsl(190 85% 40% / .12); }

    .send {
      width: 46px; height: 46px; border-radius: 50%;
      border: none; cursor: pointer; color: white;
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      display: grid; place-items: center; font-size: 18px; box-shadow: var(--shadow-2);
      transition: transform .15s ease, filter .15s ease;
    }
    .send:hover { transform: translateY(-1px); filter: brightness(1.05); }
    .send:disabled { opacity: .6; cursor: not-allowed; }

    .disclaimer { text-align: center; font-size: 12px; opacity: .65; padding-top: 8px; }

    /* Right rail */
    .rail { display: grid; grid-template-rows: auto 1fr; height: 100%; }
    .rail-head { padding: 16px 16px 10px; border-bottom: 1px solid var(--border); background: var(--bg-elev); }
    .rail-head h3 { font-size: 16px; }
    .rail-head p { font-size: 12px; opacity: .65; margin-top: 4px; }

    .rail-body { padding: 14px; overflow-y: auto; background: var(--bg-elev); }
    .card { background: var(--muted); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 12px; margin-bottom: 10px; cursor: pointer; transition: background .15s ease, transform .05s ease; box-shadow: var(--shadow-1); }
    .card:hover { background: hsl(190 85% 96%); transform: translateY(-1px); }

    .status-badges { display: flex; gap: 8px; flex-wrap: wrap; }
    .badge { font-size: 11px; background: var(--muted); border: 1px solid var(--border); padding: 6px 10px; border-radius: 999px; }

    /* Responsive */
    @media (max-width: 980px) {
      .app { grid-template-columns: 1fr; }
      .panel.rail { display: none; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Main chat panel -->
    <section class="panel chat">
      <header class="header">
        <div class="brand">
          <div class="logo" aria-hidden="true">‚úö</div>
          <div>
            <div class="title">GlycoGuide</div>
            <div class="subtitle">Diabetes Care Assistant</div>
          </div>
        </div>
        <div class="header-actions">
          <div class="pill" title="HIPAA-style privacy not guaranteed; educational use only">AI Assistant ‚Ä¢ Medical Guidance</div>
          <button class="upload-button" onclick="document.getElementById('fileInput').click()">üìÅ Upload Report</button>
          <input type="file" id="fileInput" accept="image/*" onchange="handleFileUpload(event)" />
        </div>
      </header>

      <div class="messages" id="chatMessages" aria-live="polite">
        <div class="msg ai">
          <div class="avatar">ü§ñ</div>
          <div class="bubble">
            Hello! I'm your diabetes care assistant. I'm here to help you with blood sugar management, medications, diet planning, and any diabetes-related questions. How can I assist you today? <span style="color: var(--primary);">üíô</span>
          </div>
        </div>
      </div>

      <footer class="composer">
        <div class="composer-wrap">
          <input
            type="text"
            id="messageInput"
            class="input"
            placeholder="Ask about blood sugar, medications, diet, or any diabetes concerns..."
            onkeypress="handleKeyPress(event)"
            aria-label="Message input"
          />
          <button class="send" onclick="sendMessage()" id="sendButton" aria-label="Send message">‚û§</button>
        </div>
        <p class="disclaimer">AI responses are for educational purposes. Always consult your healthcare provider.</p>
      </footer>
    </section>

    <!-- Right rail: recommendations -->
    <aside class="panel rail">
      <div class="rail-head">
        <h3>Clinical Quick Actions</h3>
        <p>Fast guidance for diabetes self‚Äëmanagement</p>
        <div class="status-badges" style="margin-top:8px">
          <span class="badge">Evidence‚Äëinformed</span>
          <span class="badge">No diagnosis</span>
          <span class="badge">Privacy-aware</span>
        </div>
      </div>
      <div class="rail-body" id="recommendations">
        <div class="card" onclick="setMessage('What should my blood sugar levels be?')">üè∑Ô∏è What‚Äôs my target blood sugar range?</div>
        <div class="card" onclick="setMessage('What are some healthy meal ideas for diabetes?')">ü•ó Healthy meal ideas</div>
        <div class="card" onclick="setMessage('What exercises are good for diabetics?')">üí™ Exercise recommendations</div>
        <div class="card" onclick="setMessage('How can I better manage my diabetes medication schedule?')">üíä Medication reminders</div>
        <div class="card" onclick="setMessage('How to check blood sugar levels correctly')">ü©∏ Blood sugar monitoring</div>
        <div class="card" onclick="setMessage('Best foods for diabetes control')">üõí Diabetes‚Äëfriendly foods</div>
        <div class="card" onclick="setMessage('Signs of hypoglycemia')">‚ö†Ô∏è Emergency: Low blood sugar</div>
      </div>
    </aside>
  </div>

  <script>
    // ------------------------------
    // GlycoGuide Diabetes Chatbot JS
    // (Functionality unchanged ‚Äì UI only)
    // ------------------------------

    class DiabetesChatbot {
      constructor() {
        this.supabaseUrl = 'https://zcprwnfhzyumumrijanw.supabase.co';
        this.supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpjcHJ3bmZoenl1bXVtcmlqYW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2MzgwOTEsImV4cCI6MjA3MjIxNDA5MX0.RssRjNYyZGJXOYkrhU0V-BcEJaAFwfqLRtugbe8LwWg';
        this.chatHistory = [];
        this.isLoading = false;
        this.initializeEventListeners();
      }

      initializeEventListeners() {
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        messageInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); this.sendMessage(); }
        });
        sendButton.addEventListener('click', () => this.sendMessage());
      }

      async sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();
        if (!message || this.isLoading) return;
        messageInput.value = '';
        this.isLoading = true;
        this.addMessage(message, 'user');
        this.showTypingIndicator();
        try {
          const response = await this.callDiabetesChatAPI(message);
          this.hideTypingIndicator();
          if (response.response) {
            this.addMessage(response.response, 'ai');
            this.chatHistory.push({ role: 'user', content: message }, { role: 'assistant', content: response.response });
          } else {
            throw new Error('No response from AI');
          }
        } catch (error) {
          console.error('Chat error:', error);
          this.hideTypingIndicator();
          this.addMessage("I apologize, but I'm having trouble connecting right now. Please try again in a moment. If you have urgent diabetes-related concerns, please contact your healthcare provider.", 'ai');
        } finally {
          this.isLoading = false;
        }
      }

      async callDiabetesChatAPI(message) {
        const response = await fetch(`${this.supabaseUrl}/functions/v1/diabetes-chat`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${this.supabaseKey}`,
            'Content-Type': 'application/json',
            'apikey': this.supabaseKey,
          },
          body: JSON.stringify({ message, chatHistory: this.chatHistory })
        });
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return await response.json();
      }

      addMessage(content, sender) {
        const chatMessages = document.getElementById('chatMessages');
        const row = document.createElement('div');
        row.className = `msg ${sender}`;

        const avatar = document.createElement('div');
        avatar.className = 'avatar' + (sender === 'user' ? ' user' : '');
        avatar.textContent = sender === 'user' ? 'üë§' : 'ü§ñ';

        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        bubble.innerHTML = this.formatMessage(content);

        row.appendChild(avatar);
        row.appendChild(bubble);
        chatMessages.appendChild(row);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      formatMessage(content) {
        return content
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1<\/strong>')
          .replace(/\*(.*?)\*/g, '<em>$1<\/em>')
          .replace(/\n/g, '<br>')
          .replace(/üíô/g, '<span style="color: var(--primary);">üíô<\/span>');
      }

      showTypingIndicator() {
        const chatMessages = document.getElementById('chatMessages');
        const row = document.createElement('div');
        row.className = 'msg ai';
        row.id = 'typing-indicator';
        row.innerHTML = `
          <div class="avatar">ü§ñ<\/div>
          <div class="bubble"><span class="typing"><span class="dot"><\/span><span class="dot"><\/span><span class="dot"><\/span><\/span><\/div>
        `;
        chatMessages.appendChild(row);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      hideTypingIndicator() {
        const n = document.getElementById('typing-indicator');
        if (n) n.remove();
      }

      setMessage(message) {
        const messageInput = document.getElementById('messageInput');
        messageInput.value = message; messageInput.focus();
      }

      async handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        if (!file.type.startsWith('image/')) { alert('Please select an image file (JPG, PNG, etc.)'); return; }
        if (file.size > 10 * 1024 * 1024) { alert('Please select an image smaller than 10MB'); return; }
        try {
          const base64 = await this.fileToBase64(file);
          this.addMessage(`üìä Analyzing your medical report: ${file.name}...`, 'user');
          this.showTypingIndicator();
          const response = await this.analyzeReport(base64);
          this.hideTypingIndicator();
          if (response.analysis) {
            this.addMessage(`üìä <strong>Medical Report Analysis:<\/strong><br><br>${response.analysis}`, 'ai');
          } else { throw new Error('No analysis returned'); }
        } catch (error) {
          console.error('File upload error:', error);
          this.hideTypingIndicator();
          this.addMessage("I apologize, but I couldn't analyze your report right now. Please try again later or consult your healthcare provider for interpretation.", 'ai');
        }
      }

      async analyzeReport(base64Image) {
        const response = await fetch(`${this.supabaseUrl}/functions/v1/analyze-report`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${this.supabaseKey}`,
            'Content-Type': 'application/json',
            'apikey': this.supabaseKey,
          },
          body: JSON.stringify({ imageBase64: base64Image, additionalContext: '' })
        });
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return await response.json();
      }

      fileToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = () => resolve(reader.result);
          reader.onerror = (err) => reject(err);
        });
      }
    }

    // Global handlers expected by HTML
    let chatbot;
    function sendMessage() { chatbot.sendMessage(); }
    function setMessage(message) { chatbot.setMessage(message); }
    function handleKeyPress(event) {
      if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }
    }
    function handleFileUpload(event) { chatbot.handleFileUpload(event); }

    document.addEventListener('DOMContentLoaded', () => {
      chatbot = new DiabetesChatbot();
      console.log('GlycoGuide Diabetes Chatbot initialized successfully!');
    });
  </script>
</body>
</html>
